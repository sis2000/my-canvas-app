<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç¿’æ…£è¿½è¹¤å™¨</title>
    
    <!-- 1. è¼‰å…¥æ ¸å¿ƒåº« (React, Tailwind) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¨­å®šå­—é«”èˆ‡åŸºæœ¬æ¨£å¼ -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ---------------------------------------------------------------------------
        // 0. æ‰‹å‹•å®šç¾©åœ–ç¤º (å› ç‚ºæ²’æœ‰å®‰è£ç’°å¢ƒï¼Œæˆ‘å€‘ç›´æ¥ç•« SVG)
        // ---------------------------------------------------------------------------
        const Icon = ({ path, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Plus = (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />;
        const Trash2 = (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />;
        const Check = (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12"/>} />;
        const Flame = (props) => <Icon {...props} fill={props.fill || "none"} path={<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.09.88-2.15 1.7-2.9.3 2.1 1.3 3.7 1.3 5.7z"/>} />;
        const Trophy = (props) => <Icon {...props} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2h-4c0 1.25-.9 2.1-2 2.1s-2-.85-2-2.1H6c-2.3 0-4 1.7-4 4 0 4.1 3 7.3 7 7.9V14c0 1.5 1 2.5 3 2.5s3-1 3-2.5v-.1c4-.6 7-3.8 7-7.9 0-2.3-1.7-4-4-4z"/></>} />;
        const CalendarIcon = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const ChevronLeft = (props) => <Icon {...props} path={<path d="m15 18-6-6 6-6"/>} />;
        const ChevronRight = (props) => <Icon {...props} path={<path d="m9 18 6-6-6-6"/>} />;
        const Sparkles = (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></>} />;
        const Lightbulb = (props) => <Icon {...props} path={<><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></>} />;
        const Loader2 = (props) => <Icon {...props} className={`${props.className} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />;

        // ---------------------------------------------------------------------------
        // 1. API è¨­å®š (è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ API Key)
        // ---------------------------------------------------------------------------
        const apiKey = ""; // <--- è²¼ä¸Šä½ çš„ API Key

        async function getGeminiSuggestions(goal) {
          if (!apiKey) {
            alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Gemini API Keyï¼");
            return [];
          }
          const systemPrompt = `
            ä½ æ˜¯ä¸€ä½è¡Œç‚ºå¿ƒç†å­¸å®¶å’Œç¿’æ…£é¤Šæˆå°ˆå®¶ã€‚ä½¿ç”¨è€…æœƒå‘Šè¨´ä½ ä¸€å€‹ä»–å€‘æƒ³é”æˆçš„ç›®æ¨™ã€‚
            è«‹æ ¹æ“šé€™å€‹ç›®æ¨™ï¼Œå»ºè­° 3 å€‹å…·é«”ã€å¯åŸ·è¡Œã€ä¸”é©åˆæ¯å¤©åšçš„ã€Œå¾®ç¿’æ…£ã€(Atomic Habits)ã€‚
            è«‹åš´æ ¼éµå®ˆä»¥ä¸‹ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ¨™è¨˜ï¼š
            [
              { "name": "ç¿’æ…£åç¨±(é™12å­—å…§)", "reason": "ç‚ºä»€éº¼é€™æœ‰å¹«åŠ©(é™20å­—å…§)" },
              { "name": "ç¿’æ…£åç¨±", "reason": "åŸå› " },
              { "name": "ç¿’æ…£åç¨±", "reason": "åŸå› " }
            ]
            èªè¨€ï¼šç¹é«”ä¸­æ–‡ (å°ç£)ã€‚
            ä½¿ç”¨è€…ç›®æ¨™ï¼š${goal}
          `;

          try {
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: systemPrompt }] }],
                  generationConfig: { responseMimeType: "application/json" }
                }),
              }
            );
            if (!response.ok) throw new Error("API call failed");
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(text);
          } catch (error) {
            console.error("Gemini API Error:", error);
            alert("AI é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·š");
            return [];
          }
        }

        // ---------------------------------------------------------------------------
        // 2. MiniCalendar çµ„ä»¶
        // ---------------------------------------------------------------------------
        const MiniCalendar = ({ completedDates, colorClass }) => {
          const [currentDate, setCurrentDate] = useState(new Date());
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const firstDayOfMonth = new Date(year, month, 1).getDay();

          const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
          const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

          const renderDays = () => {
            const days = [];
            for (let i = 0; i < firstDayOfMonth; i++) {
              days.push(<div key={`empty-${i}`} className="h-8 w-8"></div>);
            }
            for (let day = 1; day <= daysInMonth; day++) {
              const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              const isCompleted = completedDates.includes(dateStr);
              const isToday = dateStr === new Date().toISOString().split('T')[0];

              days.push(
                <div key={day} className="flex flex-col items-center justify-center h-8 w-8 relative">
                  <span className={`text-xs z-10 ${isCompleted ? 'text-white font-bold' : isToday ? 'text-indigo-600 font-bold' : 'text-slate-600'}`}>
                    {day}
                  </span>
                  {isCompleted && <div className={`absolute inset-0 m-1 rounded-full ${colorClass || 'bg-green-500'}`}></div>}
                  {!isCompleted && isToday && <div className="absolute inset-0 m-1 rounded-full border-2 border-indigo-200"></div>}
                </div>
              );
            }
            return days;
          };

          const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];

          return (
            <div className="bg-slate-50 rounded-xl p-4 mt-4 border border-slate-100 animate-in fade-in slide-in-from-top-2 duration-200">
              <div className="flex justify-between items-center mb-4">
                <button onClick={prevMonth} className="p-1 hover:bg-slate-200 rounded-full transition-colors"><ChevronLeft className="w-4 h-4 text-slate-500" /></button>
                <span className="text-sm font-bold text-slate-700">{year}å¹´ {monthNames[month]}</span>
                <button onClick={nextMonth} className="p-1 hover:bg-slate-200 rounded-full transition-colors"><ChevronRight className="w-4 h-4 text-slate-500" /></button>
              </div>
              <div className="grid grid-cols-7 gap-1 text-center mb-2">
                {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d} className="text-xs text-slate-400 font-medium h-6">{d}</div>)}
                {renderDays()}
              </div>
            </div>
          );
        };

        // ---------------------------------------------------------------------------
        // 3. Main App çµ„ä»¶
        // ---------------------------------------------------------------------------
        const App = () => {
          const [habits, setHabits] = useState(() => {
            const saved = localStorage.getItem('my-habits');
            if (saved) return JSON.parse(saved);
            return [
              { id: '1', name: 'å– 2000cc çš„æ°´', completedDates: [] },
              { id: '2', name: 'é–±è®€ 30 åˆ†é˜', completedDates: [] },
            ];
          });

          const [newHabitName, setNewHabitName] = useState('');
          const [expandedHabitId, setExpandedHabitId] = useState(null);
          const [showAI, setShowAI] = useState(false);
          const [aiGoal, setAiGoal] = useState('');
          const [aiSuggestions, setAiSuggestions] = useState([]);
          const [loadingAI, setLoadingAI] = useState(false);

          useEffect(() => {
            localStorage.setItem('my-habits', JSON.stringify(habits));
          }, [habits]);

          const getTodayString = () => new Date().toISOString().split('T')[0];
          const today = getTodayString();

          const calculateStreak = (completedDates) => {
            if (!completedDates || completedDates.length === 0) return 0;
            const sortedDates = [...completedDates].sort((a, b) => new Date(b) - new Date(a));
            const todayStr = getTodayString();
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            let streak = 0;
            let currentCheckDate = new Date();

            if (sortedDates.includes(todayStr)) {
              streak = 1; currentCheckDate.setDate(currentCheckDate.getDate() - 1);
            } else if (sortedDates.includes(yesterdayStr)) {
              streak = 0; currentCheckDate.setDate(currentCheckDate.getDate() - 1); 
            } else { return 0; }

            while (true) {
              const dateStr = currentCheckDate.toISOString().split('T')[0];
              if (sortedDates.includes(dateStr)) {
                if (dateStr !== todayStr) streak++;
                currentCheckDate.setDate(currentCheckDate.getDate() - 1);
              } else { break; }
            }
            return streak;
          };

          const addHabit = (name) => {
            if (!name.trim()) return;
            const newHabit = { id: Date.now().toString() + Math.random().toString().slice(2, 5), name: name, completedDates: [] };
            setHabits([...habits, newHabit]);
          };

          const handleManualAdd = (e) => { e.preventDefault(); addHabit(newHabitName); setNewHabitName(''); };
          
          const toggleHabit = (id) => {
            setHabits(habits.map(habit => {
              if (habit.id === id) {
                const isCompletedToday = habit.completedDates.includes(today);
                let newDates = isCompletedToday ? habit.completedDates.filter(date => date !== today) : [...habit.completedDates, today];
                return { ...habit, completedDates: newDates };
              }
              return habit;
            }));
          };

          const deleteHabit = (id) => { if (window.confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) setHabits(habits.filter(h => h.id !== id)); };
          const toggleCalendar = (id) => setExpandedHabitId(expandedHabitId === id ? null : id);
          
          const handleAIGenerate = async (e) => {
            e.preventDefault();
            if (!aiGoal.trim()) return;
            setLoadingAI(true);
            setAiSuggestions([]);
            const suggestions = await getGeminiSuggestions(aiGoal);
            setAiSuggestions(suggestions);
            setLoadingAI(false);
          };

          const addAISuggestion = (name) => {
            addHabit(name);
            setAiSuggestions(prev => prev.filter(s => s.name !== name));
          };

          const completedCount = habits.filter(h => h.completedDates.includes(today)).length;
          const progressPercentage = habits.length > 0 ? (completedCount / habits.length) * 100 : 0;
          const allCompleted = habits.length > 0 && completedCount === habits.length;

          return (
            <div className="min-h-screen bg-slate-50 py-8 px-4 font-sans text-slate-800">
              <div className="max-w-md mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                <div className="bg-indigo-600 p-6 text-white">
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <h1 className="text-2xl font-bold flex items-center gap-2"><Trophy className="w-6 h-6 text-yellow-300" />æ¯æ—¥ç¿’æ…£</h1>
                      <p className="text-indigo-200 text-sm mt-1 flex items-center gap-1"><CalendarIcon className="w-3 h-3" />{new Date().toLocaleDateString('zh-TW')}</p>
                    </div>
                    <div className="text-right"><span className="text-3xl font-bold">{completedCount}</span><span className="text-indigo-300 text-sm">/{habits.length}</span></div>
                  </div>
                  <div className="mt-2">
                    <div className="flex justify-between text-xs text-indigo-200 mb-1"><span>ä»Šæ—¥é€²åº¦</span><span>{Math.round(progressPercentage)}%</span></div>
                    <div className="w-full bg-indigo-900/30 rounded-full h-2.5">
                      <div className="bg-gradient-to-r from-yellow-400 to-orange-500 h-2.5 rounded-full transition-all duration-500 ease-out" style={{ width: `${progressPercentage}%` }}></div>
                    </div>
                  </div>
                </div>

                <div className="p-6">
                  <div className="mb-6 space-y-3">
                    <form onSubmit={handleManualAdd} className="relative">
                      <input type="text" value={newHabitName} onChange={(e) => setNewHabitName(e.target.value)} placeholder="æ–°å¢ä¸€å€‹ç¿’æ…£..." className="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                      <button type="submit" disabled={!newHabitName.trim()} className="absolute right-2 top-2 bottom-2 bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg disabled:opacity-50"><Plus className="w-5 h-5" /></button>
                    </form>

                    <button onClick={() => setShowAI(!showAI)} className={`w-full py-2 px-4 rounded-xl flex items-center justify-center gap-2 text-sm font-medium transition-all ${showAI ? 'bg-purple-100 text-purple-700' : 'bg-white border text-slate-500'}`}>
                      <Sparkles className={`w-4 h-4 ${showAI ? 'text-purple-600' : 'text-slate-400'}`} />{showAI ? 'é—œé–‰ AI æ•™ç·´' : 'è©¢å• AI æ•™ç·´'}
                    </button>

                    {showAI && (
                      <div className="bg-purple-50 rounded-xl p-4 border border-purple-100">
                        <p className="text-purple-800 text-sm font-bold mb-2 flex items-center gap-2"><Lightbulb className="w-4 h-4" />ç›®æ¨™æ˜¯ä»€éº¼ï¼Ÿ</p>
                        <form onSubmit={handleAIGenerate} className="flex gap-2">
                          <input type="text" value={aiGoal} onChange={(e) => setAiGoal(e.target.value)} placeholder="ä¾‹ï¼šæƒ³æ”¹å–„ç¡çœ ..." className="flex-1 px-3 py-2 text-sm rounded-lg border border-purple-200" />
                          <button type="submit" disabled={loadingAI || !aiGoal.trim()} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50">
                            {loadingAI ? <Loader2 className="w-4 h-4 animate-spin" /> : 'ç”Ÿæˆ'}
                          </button>
                        </form>
                        {aiSuggestions.length > 0 && (
                          <div className="mt-4 space-y-2">
                            {aiSuggestions.map((s, idx) => (
                              <div key={idx} className="bg-white p-3 rounded-lg border border-purple-100 shadow-sm flex items-center justify-between">
                                <div className="flex-1 min-w-0 mr-2"><h4 className="font-bold text-slate-700 text-sm">{s.name}</h4><p className="text-xs text-slate-500 truncate">{s.reason}</p></div>
                                <button onClick={() => addAISuggestion(s.name)} className="bg-purple-100 text-purple-700 p-1.5 rounded-md"><Plus className="w-4 h-4" /></button>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  <div className="space-y-3">
                    {habits.map(habit => {
                      const isCompleted = habit.completedDates.includes(today);
                      const streak = calculateStreak(habit.completedDates);
                      const isExpanded = expandedHabitId === habit.id;
                      return (
                        <div key={habit.id} className={`group p-4 rounded-xl border transition-all ${isCompleted ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4 overflow-hidden flex-1">
                              <button onClick={() => toggleHabit(habit.id)} className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center transition-all ${isCompleted ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-300'}`}><Check className="w-5 h-5" /></button>
                              <div className="min-w-0 flex-1 cursor-pointer" onClick={() => toggleCalendar(habit.id)}>
                                <h3 className={`font-medium truncate ${isCompleted ? 'text-slate-500 line-through' : 'text-slate-700'}`}>{habit.name}</h3>
                                <div className="flex items-center gap-2 mt-0.5"><span className={`text-xs font-bold flex items-center gap-1 ${streak > 0 ? 'text-orange-500' : 'text-slate-400'}`}><Flame className="w-3 h-3" fill={streak > 0 ? "currentColor" : "none"} />{streak} å¤©é€£çºŒ</span></div>
                              </div>
                            </div>
                            <div className="flex items-center gap-1">
                              <button onClick={() => toggleCalendar(habit.id)} className={`p-2 rounded-lg ${isExpanded ? 'bg-indigo-100 text-indigo-600' : 'text-slate-300'}`}><CalendarIcon className="w-4 h-4" /></button>
                              <button onClick={() => deleteHabit(habit.id)} className="text-slate-300 hover:text-red-500 p-2"><Trash2 className="w-4 h-4" /></button>
                            </div>
                          </div>
                          {isExpanded && <MiniCalendar completedDates={habit.completedDates} colorClass={isCompleted ? 'bg-green-500' : 'bg-indigo-500'} />}
                        </div>
                      );
                    })}
                  </div>
                  {allCompleted && habits.length > 0 && <div className="mt-6 text-center animate-bounce"><span className="inline-block bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full border border-yellow-200">ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥ç›®æ¨™å…¨éƒ¨é”æˆï¼</span></div>}
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>