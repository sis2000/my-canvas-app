<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Èõ≤Á´ØÁøíÊÖ£ËøΩËπ§Âô® | Habit Tracker</title>
    
    <!-- 1. Ê†∏ÂøÉÂ∫´ËºâÂÖ• -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Firebase SDK Ê®°ÁµÑ -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, getDocs, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FirebaseSDK = { 
            initializeApp, getApps, getApp, getAuth, signInAnonymously, onAuthStateChanged, 
            getFirestore, doc, setDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, getDocs, orderBy, writeBatch 
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .user-list-scroll { max-height: 220px; overflow-y: auto; }
        .user-list-scroll::-webkit-scrollbar { width: 4px; }
        .user-list-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        .btn-user-press { transition: transform 1.5s linear, background-color 1.5s linear; }
        .long-press-active { transform: scale(0.9) !important; background-color: #ef4444 !important; color: white !important; }
        
        @keyframes pulse-dot {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.15); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }
        .dot-active { animation: pulse-dot 2s infinite; }
        
        .check-pop { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .check-pop:active { transform: scale(0.85); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const myCustomFirebaseConfig = {
            apiKey: "AIzaSyAZZGBhfoPg8jfO78D0Z6irPRLgNBW_yPE",
            authDomain: "github-5d518.firebaseapp.com",
            projectId: "github-5d518",
            storageBucket: "github-5d518.firebasestorage.app",
            messagingSenderId: "562364204504",
            appId: "1:562364204504:web:9911be99590c2b1fd41ead"
        };
        const geminiApiKey = "AIzaSyCm3_30XFuMUBlfvTCnWKPaWrUGoxpW1gc";
        
        const DB_BASE = ['artifacts', 'habit-tracker', 'public', 'data']; 

        const translations = {
            zh: {
                title: "Èõ≤Á´ØÁøíÊÖ£",
                statusLocal: "Êú¨Ê©üÊ®°Âºè",
                statusCloud: "Èõ≤Á´ØÂ∑≤ÈÄ£Á∑ö",
                statusSyncing: "ÈÄ£Á∑ö‰∏≠...",
                switchUser: "ÂàáÊèõ‰ΩøÁî®ËÄÖ",
                recentUsers: "Èõ≤Á´ØÂ∏≥ËôüÊ∏ÖÂñÆ",
                longPressTip: "(Èï∑ÊåâÊåâÈàï 1.5 ÁßíÈñãÂïü‰øÆÊîπ/Âà™Èô§)",
                rename: "‰øÆÊîπÂêçÁ®±",
                delete: "Âà™Èô§Èõ≤Á´ØË≥áÊñô",
                inputNewName: "Ëº∏ÂÖ•Êñ∞ÂêçÁ®±...",
                renameTitle: "‰øÆÊîπÂ∏≥ËôüÂêçÁ®±",
                renameBody: "Â∞á „Äå{old}„Äç ÊîπÂêçÁÇ∫ „Äå{new}„Äç ÂóéÔºü",
                movingData: "ÂêåÊ≠•ÈÅ∑Áßª‰∏≠...",
                confirm: "Á¢∫Ë™ç",
                cancel: "ÂèñÊ∂à",
                streak: "Â§©ÈÄ£Á∫å",
                noHabits: "ÈÇÑÊ≤íÊúâÁøíÊÖ£ÔºåÈªûÊìä‰∏äÊñπ ‚ú® ÊàñÁõ¥Êé•Êñ∞Â¢ûÂêßÔºÅ",
                addPlaceholder: "Êñ∞Â¢û‰∏ÄÂÄãÁøíÊÖ£ÁõÆÊ®ô...",
                deleteHabitConfirm: "Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÁøíÊÖ£ÂóéÔºü",
                deleteUserTitle: "Âà™Èô§Èõ≤Á´ØÂ∏≥Ëôü",
                deleteUserBody: "Âà™Èô§ „Äå{name}„Äç ÊúÉÊ∏ÖÁ©∫Èõ≤Á´ØË≥áÊñô‰∏îÁÑ°Ê≥ïÊÅ¢Âæ©ÔºÅ",
                userOptionsTitle: "Â∏≥ËôüÁÆ°ÁêÜ",
                aiGoalPlaceholder: "Â¶ÇÔºöÊÉ≥Êõ¥ÊúâÊ¥ªÂäõ„ÄÅÊØèÂ§©ÈÅãÂãï...",
                aiGenerate: "ÁîüÊàê",
                aiSystemPrompt: "Êé®Ëñ¶3ÂÄãÁπÅÈ´î‰∏≠ÊñáÂæÆÁøíÊÖ£„ÄÇJSONÊ†ºÂºè„ÄÇ",
                todayProgress: "‰ªäÊó•ÈÄ≤Â∫¶",
                months: ["‰∏ÄÊúà", "‰∫åÊúà", "‰∏âÊúà", "ÂõõÊúà", "‰∫îÊúà", "ÂÖ≠Êúà", "‰∏ÉÊúà", "ÂÖ´Êúà", "‰πùÊúà", "ÂçÅÊúà", "ÂçÅ‰∏ÄÊúà", "ÂçÅ‰∫åÊúà"],
                quotes: ["ÊàêÂäüÊ∫êÊñºÊØèÂ§©ÁöÑÁ¥ØÁ©ç„ÄÇ","ÂçìË∂ä‰∏çÊòØË°åÁÇ∫ÔºåËÄåÊòØÁøíÊÖ£„ÄÇ","ÊØèÂ§©ÈÄ≤Ê≠•1%"]
            },
            vi: {
                title: "Th√≥i Quen Cloud",
                statusLocal: "Ch·∫ø ƒë·ªô n·ªôi b·ªô",
                statusCloud: "Cloud connected",
                statusSyncing: "ƒêang k·∫øt n·ªëi...",
                switchUser: "Ng∆∞·ªùi d√πng",
                recentUsers: "Danh s√°ch t√†i kho·∫£n",
                longPressTip: "(Nh·∫•n gi·ªØ 1.5 gi√¢y ƒë·ªÉ t√πy ch·ªçn)",
                rename: "ƒê·ªïi t√™n",
                delete: "X√≥a d·ªØ li·ªáu Cloud",
                inputNewName: "Nh·∫≠p t√™n m·ªõi...",
                renameTitle: "ƒê·ªïi t√™n t√†i kho·∫£n",
                renameBody: "ƒê·ªïi „Äå{old}„Äç th√†nh „Äå{new}„Äç?",
                movingData: "ƒêang ƒë·ªìng b·ªô...",
                confirm: "X√°c nh·∫≠n",
                cancel: "H·ªßy",
                streak: "ng√†y li√™n ti·∫øp",
                noHabits: "Ch∆∞a c√≥ th√≥i quen, th√™m ngay th√¥i!",
                addPlaceholder: "Th√™m th√≥i quen m·ªõi...",
                deleteHabitConfirm: "X√≥a th√≥i quen n√†y?",
                deleteUserTitle: "X√≥a t√†i kho·∫£n",
                deleteUserBody: "X√≥a „Äå{name}„Äç s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu Cloud!",
                userOptionsTitle: "Qu·∫£n l√Ω t√†i kho·∫£n",
                aiGoalPlaceholder: "VD: mu·ªën kh·ªèe m·∫°nh h∆°n...",
                aiGenerate: "T·∫°o",
                aiSystemPrompt: "G·ª£i √Ω 3 th√≥i quen nh·ªè b·∫±ng ti·∫øng Vi·ªát. ƒê·ªãnh d·∫°ng JSON.",
                todayProgress: "Ti·∫øn ƒë·ªô",
                months: ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6", "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"],
                quotes: ["Th√†nh c√¥ng b·∫Øt ƒë·∫ßu t·ª´ t√≠ch l≈©y.","S·ª± xu·∫•t s·∫Øc l√† m·ªôt th√≥i quen."]
            },
            en: {
                title: "Habit Tracker",
                statusLocal: "Local Mode",
                statusCloud: "Cloud Synced",
                statusSyncing: "Syncing...",
                switchUser: "Switch User",
                recentUsers: "Cloud Accounts",
                longPressTip: "(Hold for 1.5s to options)",
                rename: "Rename",
                delete: "Delete Cloud Data",
                inputNewName: "New name...",
                renameTitle: "Rename Account",
                renameBody: "Rename „Äå{old}„Äç to „Äå{new}„Äç?",
                movingData: "Moving data...",
                confirm: "Confirm",
                cancel: "Cancel",
                streak: "day streak",
                noHabits: "No habits yet, add one!",
                addPlaceholder: "Add a habit goal...",
                deleteHabitConfirm: "Delete this habit?",
                deleteUserTitle: "Delete Account",
                deleteUserBody: "This will erase cloud data for „Äå{name}„Äç!",
                userOptionsTitle: "Account Settings",
                aiGoalPlaceholder: "e.g. be more active...",
                aiGenerate: "Generate",
                aiSystemPrompt: "Recommend 3 micro-habits in English. JSON format.",
                todayProgress: "Today's Progress",
                months: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                quotes: ["Excellence is not an act, but a habit."]
            }
        };

        const stringToColor = (str) => {
            if (!str) return "#6366f1";
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 65%, 45%)`;
        };

        const CustomModal = ({ isOpen, title, body, onConfirm, onCancel, confirmText, cancelText, loading, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-3xl w-full max-w-xs p-6 shadow-2xl animate-in zoom-in-95 duration-200 border">
                        <h3 className="text-lg font-bold text-slate-800 mb-2">{title}</h3>
                        <p className="text-sm text-slate-500 mb-5 leading-relaxed">{body}</p>
                        {children}
                        {loading ? (
                            <div className="flex justify-center py-2"><div className="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>
                        ) : (
                            <div className="flex flex-col gap-2 mt-2">
                                {onConfirm && <button onClick={onConfirm} className="w-full py-3 rounded-2xl bg-indigo-600 text-white font-bold text-sm shadow-lg shadow-indigo-100">{confirmText}</button>}
                                <button onClick={onCancel} className="w-full py-3 rounded-2xl bg-slate-50 text-slate-500 font-bold text-sm">{cancelText}</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MiniCalendar = ({ completedDates, colorClass, lang }) => {
            const t = translations[lang] || translations.zh;
            const fallbackMonths = translations.zh.months;
            const [viewDate, setViewDate] = useState(new Date());
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const firstDay = new Date(y, m, 1).getDay();
            
            const renderDays = () => {
                const ds = [];
                for (let i = 0; i < firstDay; i++) ds.push(<div key={`e-${i}`} className="h-7 w-7"></div>);
                for (let d = 1; d <= daysInMonth; d++) {
                    const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const isDone = completedDates?.includes(dStr);
                    ds.push(
                        <div key={d} className="flex items-center justify-center h-7 w-7 relative text-[10px]">
                            <span className={`z-10 ${isDone ? 'text-white font-bold' : 'text-slate-600'}`}>{d}</span>
                            {isDone && <div className={`absolute inset-0 m-0.5 rounded-full ${colorClass}`}></div>}
                        </div>
                    );
                }
                return ds;
            };

            return (
                <div className="bg-slate-50 rounded-xl p-3 mt-4 border border-slate-100">
                    <div className="flex justify-between items-center mb-2 text-xs font-bold text-slate-700">
                        <button onClick={() => setViewDate(new Date(y, m - 1, 1))}>&lt;</button>
                        <span>{(t.months && t.months[m]) ? t.months[m] : fallbackMonths[m]} {y}</span>
                        <button onClick={() => setViewDate(new Date(y, m + 1, 1))}>&gt;</button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center">
                        {['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'].map(d => <div key={d} className="text-[10px] text-slate-400 font-bold">{d}</div>)}
                        {renderDays()}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [lang, setLang] = useState(localStorage.getItem('habit-lang') || 'zh');
            const t = translations[lang] || translations.zh;
            const [activeName, setActiveName] = useState(localStorage.getItem('habit-user-name') || 'Guest');
            const [userList, setUserList] = useState(['Guest']);
            const [habits, setHabits] = useState([]);
            const [loading, setLoading] = useState(true);
            const [connStatus, setConnStatus] = useState('syncing'); 
            const [showUserPanel, setShowUserPanel] = useState(false);
            const [tempName, setTempName] = useState('');
            const [editInput, setEditInput] = useState('');
            const [showAI, setShowAI] = useState(false);
            const [aiGoal, setAiGoal] = useState('');
            const [aiSuggestions, setAiSuggestions] = useState([]);
            const [loadingAI, setLoadingAI] = useState(false);
            const [expandedId, setExpandedId] = useState(null);
            const [modal, setModal] = useState({ isOpen: false, type: '', data: null, loading: false });
            
            const dbRef = useRef(null);
            const pressTimer = useRef(null);
            const [pressingUser, setPressingUser] = useState(null);
            const hasTriggeredLongPress = useRef(false);
            const today = new Date().toISOString().split('T')[0];

            useEffect(() => {
                const initFirebase = async () => {
                    const sdk = window.FirebaseSDK;
                    if (!sdk) { setConnStatus('local'); setLoading(false); return; }
                    try {
                        let app = sdk.getApps().length === 0 ? sdk.initializeApp(myCustomFirebaseConfig) : sdk.getApp();
                        const auth = sdk.getAuth(app);
                        dbRef.current = sdk.getFirestore(app);
                        sdk.onAuthStateChanged(auth, async (user) => {
                            if (user) setConnStatus('cloud');
                            else sdk.signInAnonymously(auth).catch(() => setConnStatus('local'));
                        });
                    } catch (e) { setConnStatus('local'); setLoading(false); }
                };
                if (window.FirebaseSDK) initFirebase();
                else window.addEventListener('firebase-ready', initFirebase);
            }, []);

            useEffect(() => {
                if (connStatus !== 'cloud' || !dbRef.current) return;
                const { collection, onSnapshot } = window.FirebaseSDK;
                const unsub = onSnapshot(collection(dbRef.current, ...DB_BASE, 'user_registry'), (snap) => {
                    const names = snap.docs.map(doc => doc.id);
                    if (names.length > 0) setUserList(names);
                });
                return () => unsub();
            }, [connStatus]);

            useEffect(() => {
                if (connStatus !== 'cloud' || !dbRef.current) {
                    if (connStatus !== 'syncing') {
                        setHabits(JSON.parse(localStorage.getItem(`local-${activeName}`) || '[]'));
                        setLoading(false);
                    }
                    return;
                }
                setLoading(true);
                const { collection, onSnapshot, query, orderBy } = window.FirebaseSDK;
                const unsub = onSnapshot(query(collection(dbRef.current, ...DB_BASE, `habits_${activeName}`), orderBy('createdAt', 'asc')), (snap) => {
                    setHabits(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, (err) => {
                    if (err.code === 'permission-denied') setConnStatus('error');
                    else setConnStatus('local');
                    setLoading(false);
                });
                return () => unsub();
            }, [activeName, connStatus]);

            useEffect(() => {
                localStorage.setItem(`local-${activeName}`, JSON.stringify(habits));
            }, [habits, activeName]);

            const startPress = (name) => {
                setPressingUser(name);
                hasTriggeredLongPress.current = false;
                pressTimer.current = setTimeout(() => {
                    hasTriggeredLongPress.current = true;
                    setModal({ isOpen: true, type: 'userOptions', data: name });
                    setPressingUser(null);
                }, 1500);
            };

            const endPress = (name) => {
                if (pressTimer.current) { clearTimeout(pressTimer.current); pressTimer.current = null; }
                if (!hasTriggeredLongPress.current && pressingUser === name) {
                    setActiveName(name);
                    localStorage.setItem('habit-user-name', name);
                    setShowUserPanel(false);
                    setLoading(true);
                }
                setPressingUser(null);
            };

            const handleAddUser = async () => {
                const name = tempName.trim();
                if (!name) return;
                if (connStatus === 'cloud' && dbRef.current) {
                    const { doc, setDoc } = window.FirebaseSDK;
                    await setDoc(doc(dbRef.current, ...DB_BASE, 'user_registry', name), { exists: true });
                }
                setActiveName(name);
                localStorage.setItem('habit-user-name', name);
                setShowUserPanel(false);
                setTempName('');
            };

            const handleRenameExecute = async () => {
                const oldName = modal.data;
                const newName = editInput.trim();
                if (!newName || oldName === newName) { setModal({ isOpen: false }); return; }
                setModal({ ...modal, loading: true });
                if (connStatus === 'cloud' && dbRef.current) {
                    const { collection, getDocs, doc, writeBatch } = window.FirebaseSDK;
                    try {
                        const batch = writeBatch(dbRef.current);
                        const oldSnap = await getDocs(collection(dbRef.current, ...DB_BASE, `habits_${oldName}`));
                        oldSnap.docs.forEach(d => {
                            batch.set(doc(dbRef.current, ...DB_BASE, `habits_${newName}`, d.id), d.data());
                            batch.delete(d.ref);
                        });
                        batch.set(doc(dbRef.current, ...DB_BASE, 'user_registry', newName), { exists: true });
                        batch.delete(doc(dbRef.current, ...DB_BASE, 'user_registry', oldName));
                        await batch.commit();
                    } catch (e) { console.error(e); }
                }
                localStorage.setItem('habit-user-name', newName);
                setActiveName(newName);
                setModal({ isOpen: false, loading: false });
            };

            const confirmDeleteUser = async () => {
                const nameToDelete = modal.data;
                setModal({ ...modal, loading: true });
                if (connStatus === 'cloud' && dbRef.current) {
                    const { collection, getDocs, doc, writeBatch } = window.FirebaseSDK;
                    try {
                        const batch = writeBatch(dbRef.current);
                        const snap = await getDocs(collection(dbRef.current, ...DB_BASE, `habits_${nameToDelete}`));
                        snap.docs.forEach(d => batch.delete(d.ref));
                        batch.delete(doc(dbRef.current, ...DB_BASE, 'user_registry', nameToDelete));
                        await batch.commit();
                    } catch (e) {}
                }
                const newList = userList.filter(n => n !== nameToDelete);
                const nextActive = (newList.length > 0) ? newList[0] : 'Guest';
                setActiveName(nextActive);
                localStorage.setItem('habit-user-name', nextActive);
                setModal({ isOpen: false, loading: false });
            };

            const addHabit = async (n) => {
                if (!n.trim()) return;
                if (connStatus === 'cloud') {
                    await window.FirebaseSDK.addDoc(window.FirebaseSDK.collection(dbRef.current, ...DB_BASE, `habits_${activeName}`), { name: n, completedDates: [], createdAt: Date.now() });
                } else {
                    setHabits(prev => [...prev, { id: Date.now().toString(), name: n, completedDates: [], createdAt: Date.now() }]);
                }
            };

            const toggleHabit = (h) => {
                const isDone = h.completedDates?.includes(today);
                const newDates = isDone ? h.completedDates.filter(d => d !== today) : [...(h.completedDates || []), today];
                if (connStatus === 'cloud') {
                    window.FirebaseSDK.updateDoc(window.FirebaseSDK.doc(dbRef.current, ...DB_BASE, `habits_${activeName}`, h.id), { completedDates: newDates });
                } else {
                    setHabits(prev => prev.map(item => item.id === h.id ? { ...item, completedDates: newDates } : item));
                }
            };

            const handleAIGenerate = async (e) => {
                e.preventDefault();
                if (!aiGoal.trim() || loadingAI) return;
                setLoadingAI(true);
                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, { 
                        method: "POST", headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Goal:${aiGoal}. ${t.aiSystemPrompt}` }] }], generationConfig: { responseMimeType: "application/json" } }) 
                    });
                    const d = await r.json();
                    setAiSuggestions(JSON.parse(d.candidates[0].content.parts[0].text));
                } catch(e) { alert("AI Error"); }
                setLoadingAI(false);
            };

            const progress = habits.length > 0 ? (habits.filter(h => h.completedDates?.includes(today)).length / habits.length) * 100 : 0;

            return (
                <div className="min-h-screen bg-slate-50 py-4 px-2 flex flex-col items-center font-sans">
                    <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-xl overflow-hidden flex flex-col h-[92vh] border border-slate-100">
                        
                        <CustomModal isOpen={modal.isOpen && modal.type === 'userOptions'} title={t.userOptionsTitle} body={`Target: „Äå${modal.data}„Äç`} onCancel={() => setModal({ isOpen: false })} cancelText={t.cancel}>
                            <div className="flex flex-col gap-2 mb-4">
                                <button onClick={() => { setModal({...modal, type: 'renamePrompt'}); setEditInput(modal.data); }} className="w-full py-4 rounded-2xl bg-indigo-50 text-indigo-600 font-bold text-sm flex items-center justify-center gap-2">{t.rename}</button>
                                <button onClick={() => setModal({...modal, type: 'deleteConfirm'})} className="w-full py-4 rounded-2xl bg-red-50 text-red-600 font-bold text-sm flex items-center justify-center gap-2">{t.delete}</button>
                            </div>
                        </CustomModal>

                        <CustomModal isOpen={modal.isOpen && modal.type === 'renamePrompt'} title={t.renameTitle} body={modal.loading ? t.movingData : t.inputNewName} onConfirm={handleRenameExecute} onCancel={() => setModal({ isOpen: false })} confirmText={t.confirm} cancelText={t.cancel} loading={modal.loading}>
                            {!modal.loading && <input type="text" value={editInput} onChange={(e) => setEditInput(e.target.value)} className="w-full px-4 py-3 rounded-xl border mb-4 outline-none focus:ring-2 focus:ring-indigo-500" autoFocus />}
                        </CustomModal>

                        <CustomModal isOpen={modal.isOpen && modal.type === 'deleteConfirm'} title={t.deleteUserTitle} body={modal.loading ? t.movingData : t.deleteUserBody.replace('{name}', modal.data)} onConfirm={confirmDeleteUser} onCancel={() => setModal({ isOpen: false })} confirmText={t.confirm} cancelText={t.cancel} loading={modal.loading} />

                        <CustomModal isOpen={modal.isOpen && modal.type === 'habit'} title="Remove" body={t.deleteHabitConfirm} onConfirm={() => { if (connStatus === 'cloud') { const { doc, deleteDoc } = window.FirebaseSDK; deleteDoc(doc(dbRef.current, ...DB_BASE, `habits_${activeName}`, modal.data)); } else setHabits(prev => prev.filter(item => item.id !== modal.data)); setModal({ isOpen: false }); }} onCancel={() => setModal({ isOpen: false })} confirmText={t.confirm} cancelText={t.cancel} />
                        
                        <div className="bg-indigo-600 p-6 text-white pb-8">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <h1 className="text-2xl font-black tracking-tight flex items-center gap-2">üèÜ {t.title}</h1>
                                    <div className="text-[11px] mt-1 font-medium opacity-80 uppercase tracking-widest">
                                        {new Date().toLocaleDateString(lang === 'zh' ? 'zh-TW' : (lang === 'vi' ? 'vi-VN' : 'en-US'), { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
                                    </div>
                                </div>
                                <select value={lang} onChange={(e) => { setLang(e.target.value); localStorage.setItem('habit-lang', e.target.value); }} className="bg-white/10 text-white text-[10px] font-bold py-1 px-2 rounded-lg outline-none border border-white/20 backdrop-blur-md">
                                    <option value="zh">ÁπÅÈ´î‰∏≠Êñá</option>
                                    <option value="vi">Ti·∫øng Vi·ªát</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                            
                            <div className="flex items-center gap-2 mt-4">
                                <button onClick={() => setShowUserPanel(!showUserPanel)} className="group flex items-center gap-2 bg-white/10 hover:bg-white/20 p-1.5 pr-4 rounded-full transition-all border border-white/10 active:scale-95">
                                    <div className="relative">
                                        <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-black text-sm shadow-inner" style={{ backgroundColor: stringToColor(activeName) }}>
                                            {activeName ? activeName.charAt(0).toUpperCase() : '?'}
                                        </div>
                                        <span className={`absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-indigo-600 transition-all ${connStatus === 'cloud' ? 'bg-green-400 dot-active shadow-[0_0_8px_#4ade80]' : 'bg-slate-400'}`}></span>
                                    </div>
                                    <span className="text-sm font-bold tracking-tight">{activeName}</span>
                                </button>
                            </div>
                            
                            {showUserPanel && (
                                <div className="mt-4 bg-indigo-900/40 backdrop-blur-xl p-5 rounded-[2rem] shadow-2xl border border-white/10 animate-in fade-in zoom-in duration-300">
                                    <p className="text-[10px] font-bold text-indigo-200 mb-3 uppercase tracking-widest">{t.recentUsers}</p>
                                    <div className="flex flex-wrap gap-2 mb-4 user-list-scroll pr-1">
                                        {userList.map(n => (
                                            <button key={n} onMouseDown={() => startPress(n)} onMouseUp={() => endPress(n)} onMouseLeave={() => setPressingUser(null)} onTouchStart={() => startPress(n)} onTouchEnd={() => endPress(n)} onContextMenu={(e) => e.preventDefault()} 
                                                className={`btn-user-press flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${activeName === n ? 'bg-white text-indigo-900 border-white shadow-lg' : 'bg-white/10 text-white border-white/20 hover:bg-white/20'} ${pressingUser === n ? 'long-press-active' : ''}`}
                                            >
                                                <div className="w-4 h-4 rounded-full flex items-center justify-center text-[10px]" style={{ backgroundColor: activeName === n ? stringToColor(n) : 'rgba(255,255,255,0.3)' }}>
                                                    {n ? n.charAt(0).toUpperCase() : '?'}
                                                </div>
                                                {n}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} placeholder={t.inputNewName} className="flex-1 bg-white/10 border-white/10 border rounded-2xl px-4 py-2 text-xs text-white outline-none focus:bg-white/20 transition-all" />
                                        <button onClick={handleAddUser} className="bg-white text-indigo-600 px-5 py-2 rounded-2xl text-xs font-black shadow-lg active:scale-95">{t.confirm}</button>
                                    </div>
                                    <p className="text-[8px] text-indigo-300 mt-4 italic opacity-70 leading-tight">{t.longPressTip}</p>
                                </div>
                            )}

                            <div className="flex justify-between text-[10px] text-indigo-200 mt-6 mb-2 px-1 font-bold">
                                <span>{t.todayProgress}</span>
                                <span>{Math.round(progress)}%</span>
                            </div>
                            <div className="w-full bg-indigo-950/40 h-2 rounded-full overflow-hidden border border-white/5">
                                <div className="bg-gradient-to-r from-yellow-400 to-yellow-200 h-full transition-all duration-1000 ease-out shadow-[0_0_12px_rgba(250,204,21,0.4)]" style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>

                        <div className="p-5 flex-1 overflow-y-auto no-scrollbar -mt-4 bg-white rounded-t-[2.5rem] shadow-inner">
                            <div className="flex gap-2 mb-6 relative">
                                <div className="relative flex-1 group">
                                    <button onClick={() => setShowAI(!showAI)} className={`absolute left-3 top-1/2 -translate-y-1/2 z-10 text-lg transition-all duration-300 ${showAI ? 'grayscale-0 scale-125 rotate-12' : 'grayscale opacity-30 hover:opacity-100 hover:scale-110'}`}>‚ú®</button>
                                    <input id="habitInput" type="text" placeholder={t.addPlaceholder} className="w-full border-2 border-slate-100 rounded-2xl pl-10 pr-4 py-3.5 text-sm outline-none focus:border-indigo-500 bg-slate-50/50 transition-all font-medium" onKeyDown={(e) => { if(e.key === 'Enter' && e.target.value.trim()){ addHabit(e.target.value); e.target.value = ''; }}} />
                                </div>
                                <button onClick={() => { const input = document.getElementById('habitInput'); if(input.value.trim()){ addHabit(input.value); input.value = ''; }}} className="bg-indigo-600 text-white px-5 rounded-2xl font-black shadow-lg shadow-indigo-200 active:scale-90 transition-transform">Ôºã</button>
                            </div>
                            
                            {showAI && (
                                <div className="mb-6 bg-purple-50/50 p-5 rounded-[2rem] border-2 border-purple-100/50 animate-in slide-in-from-top-2">
                                    <form onSubmit={handleAIGenerate} className="flex gap-2 mb-3">
                                        <input type="text" value={aiGoal} onChange={(e) => setAiGoal(e.target.value)} placeholder={t.aiGoalPlaceholder} className="flex-1 text-xs p-3 rounded-xl border border-purple-200 outline-none focus:ring-2 focus:ring-purple-400 bg-white" />
                                        <button type="submit" disabled={loadingAI} className="bg-purple-600 text-white px-4 rounded-xl text-xs font-black shadow-md">{loadingAI ? '...' : t.aiGenerate}</button>
                                    </form>
                                    <div className="space-y-2">{aiSuggestions.map((s, i) => (
                                        <div key={i} className="bg-white/80 backdrop-blur-sm p-4 rounded-2xl flex justify-between items-center text-[11px] shadow-sm border border-purple-50 group hover:border-purple-300 transition-all">
                                            <div className="flex-1 mr-2"><div className="font-black text-slate-700">{s.name}</div><div className="text-slate-500 text-[10px] mt-0.5">{s.reason}</div></div>
                                            <button onClick={() => { addHabit(s.name); setAiSuggestions(prev => prev.filter(x => x.name !== s.name)); }} className="w-8 h-8 bg-purple-100 text-purple-600 rounded-full font-black text-lg flex items-center justify-center hover:bg-purple-600 hover:text-white transition-all">Ôºã</button>
                                        </div>
                                    ))}</div>
                                </div>
                            )}

                            {loading ? (
                                <div className="flex flex-col items-center justify-center py-20 gap-4">
                                    <div className="w-10 h-10 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
                                    <p className="text-slate-400 text-xs font-bold italic tracking-widest uppercase">Syncing</p>
                                </div>
                            ) : (
                                <div className="space-y-4 pb-10">
                                    {habits.map(h => {
                                        const isDone = h.completedDates?.includes(today);
                                        let streak = 0, c = new Date();
                                        if(!h.completedDates?.includes(today)) c.setDate(c.getDate()-1);
                                        while(h.completedDates?.includes(c.toISOString().split('T')[0])){ streak++; c.setDate(c.getDate()-1); }
                                        return (
                                            <div key={h.id} className={`p-4 rounded-[1.5rem] border-2 transition-all duration-500 ${isDone ? 'bg-green-50/50 border-green-100' : 'bg-white border-slate-50 shadow-sm hover:shadow-md'}`}>
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-4 flex-1 cursor-pointer" onClick={() => toggleHabit(h)}>
                                                        <div className={`check-pop w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all ${isDone ? 'bg-green-500 border-green-500 text-white shadow-lg shadow-green-200' : 'bg-white border-slate-100 text-transparent'}`}>
                                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"></path></svg>
                                                        </div>
                                                        <div>
                                                            <h3 className={`text-base font-bold tracking-tight ${isDone ? 'text-slate-400 line-through' : 'text-slate-700'}`}>{h.name}</h3>
                                                            <span className="text-[10px] text-orange-500 font-black bg-orange-50 px-2 py-0.5 rounded-lg mt-1 inline-flex items-center gap-1">üî• {streak} {t.streak}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => setExpandedId(expandedId === h.id ? null : h.id)} className={`p-2.5 rounded-xl transition-all ${expandedId === h.id ? 'bg-indigo-100 text-indigo-600 scale-110' : 'text-slate-300 hover:text-indigo-400'}`}>
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                                        </button>
                                                        <button onClick={() => setModal({ isOpen: true, type: 'habit', data: h.id })} className="text-slate-200 hover:text-red-400 p-2.5 transition-colors">
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                {expandedId === h.id && (
                                                    <div className="animate-in slide-in-from-top-4 duration-300">
                                                        <MiniCalendar completedDates={h.completedDates} colorClass={isDone ? 'bg-green-500' : 'bg-indigo-500'} lang={lang} />
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {habits.length === 0 && (
                                        <div className="text-center py-20 px-10">
                                            <div className="text-4xl mb-4 opacity-20">üçÉ</div>
                                            <p className="text-slate-300 text-xs font-bold leading-relaxed">{t.noHabits}</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="p-6 bg-slate-50 border-t border-slate-100 flex flex-col items-center">
                            <p className="text-[10px] text-slate-400 italic text-center font-medium leading-relaxed max-w-[80%]">
                                "{t.quotes[new Date().getDate() % t.quotes.length]}"
                            </p>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
