<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 習慣追蹤器 | Habit Tracker</title>
    
    <!-- 1. 載入核心庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Firebase SDK (採用模組化載入，並在載入後通知全域) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FirebaseSDK = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, 
            signInWithCustomToken, getFirestore, doc, setDoc, getDoc, 
            collection, onSnapshot, addDoc, updateDoc, deleteDoc, query 
        };
        // 發送一個事件告訴 React：Firebase 已經準備好了
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .user-list-scroll { max-height: 120px; overflow-y: auto; }
        .user-list-scroll::-webkit-scrollbar { width: 4px; }
        .user-list-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 安全的參數讀取函數 ---
        const getSafeEnv = (key, fallback) => {
            try {
                if (key === 'config') {
                    return (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : null;
                }
                if (key === 'appId') {
                    return (typeof __app_id !== 'undefined') ? __app_id : fallback;
                }
            } catch (e) { return null; }
            return null;
        };

        const firebaseConfig = getSafeEnv('config', null);
        const appId = getSafeEnv('appId', 'my-habit-tracker-app');
        const geminiApiKey = "AIzaSyCm3_30XFuMUBlfvTCnWKPaWrUGoxpW1gc";

        // --- 語言包設定 ---
        const translations = {
            zh: {
                title: "習慣追蹤",
                switchUser: "切換使用者：",
                recentUsers: "最近使用的使用者",
                addNewUser: "新增 / 手動輸入",
                inputNewName: "輸入新名稱...",
                confirm: "確認",
                switch: "切換",
                todayProgress: "今日進度",
                addPlaceholder: "新增今天的挑戰...",
                aiButtonShow: "獲取 AI 習慣推薦",
                aiButtonHide: "隱藏 AI 推薦",
                aiGoalPlaceholder: "如：我想更有活力...",
                aiGenerate: "生成",
                streak: "天連續",
                noHabits: "目前還沒有習慣，新增一個吧！",
                syncing: "正在讀取資料...",
                deleteConfirm: "確定刪除？",
                aiSystemPrompt: "你是一位行為心理學家。根據使用者的目標推薦3個繁體中文的微習慣，包含 name (10字內) 和 reason (15字內)。格式：JSON 陣列。",
                months: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                days: ['日','一','二','三','四','五','六'],
                langLabel: "語言選擇",
                dateLocale: "zh-TW",
                quotes: [
                    "成功不是將來才有的，而是從決定去做的那一刻起，持續累積而成。",
                    "不積跬步，無以至千里；不積小流，無以成江海。",
                    "所謂的運氣，不過是機會碰巧遇到了你的努力。",
                    "習慣是一條巨纜，我們每天編結其中一根股線，到最後它會變得無法弄斷。",
                    "種一棵樹最好的時間是十年前，其次是現在。",
                    "重要的不是你現在在哪裡，而是你正朝向哪個方向前進。",
                    "卓越不是一種行為，而是一種習慣。",
                    "每天進步1%，一年後你會強大37倍。",
                    "所有的偉大，都源於一個勇敢的開始。",
                    "你是自己習慣的產物，所以請選擇好的習慣。"
                ]
            },
            vi: {
                title: "Thói Quen",
                switchUser: "Người dùng: ",
                recentUsers: "Người dùng gần đây",
                addNewUser: "Thêm / Nhập thủ công",
                inputNewName: "Nhập tên mới...",
                confirm: "Xác nhận",
                switch: "Đổi",
                todayProgress: "Tiến độ hôm nay",
                addPlaceholder: "Thêm thử thách mới...",
                aiButtonShow: "Nhận gợi ý từ AI",
                aiButtonHide: "Ẩn gợi ý AI",
                aiGoalPlaceholder: "VD: Tôi muốn năng động hơn...",
                aiGenerate: "Tạo",
                streak: "ngày liên tiếp",
                noHabits: "Chưa có thói quen nào, hãy thêm mới!",
                syncing: "Đang tải dữ liệu...",
                deleteConfirm: "Bạn có chắc muốn xóa?",
                aiSystemPrompt: "Bạn là một chuyên gia tâm lý hành vi. Dựa trên mục tiêu của người dùng, hãy đề xuất 3 thói quen nhỏ bằng tiếng Việt, bao gồm name (tối đa 10 chữ) và reason (tối đa 15 chữ). Định dạng: mảng JSON.",
                months: ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"],
                days: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
                langLabel: "Ngôn ngữ",
                dateLocale: "vi-VN",
                quotes: [
                    "Thành công không phải là đích đến, mà là cả một hành trình nỗ lực không ngừng.",
                    "Hành trình vạn dặm bắt đầu từ một bước chân nhỏ bé.",
                    "May mắn thực chất là khi sự chuẩn bị gặp gỡ cơ hội.",
                    "Thói quen giống như một sợi cáp, mỗi ngày chúng ta dệt thêm một sợi cho đến khi nó không thể bị phá vỡ.",
                    "Thời điểm tốt nhất để trồng cây là 20 năm trước, thời điểm tốt thứ hai là ngay bây giờ.",
                    "Điều quan trọng không phải bạn đang đứng ở đâu, mà là bạn đang đi về hướng nào.",
                    "Sự xuất sắc không phải là một hành động, mà là một thói quen.",
                    "Mỗi ngày tiến bộ 1%, sau một năm bạn sẽ giỏi hơn gấp 37 lần.",
                    "Mọi điều vĩ đại đều bắt đầu từ một khởi đầu dũng cảm.",
                    "Bạn chính là kết quả của những thói quen mà bạn nuôi dưỡng."
                ]
            },
            en: {
                title: "Habit Tracker",
                switchUser: "User: ",
                recentUsers: "Recent Users",
                addNewUser: "Add / Manual Input",
                inputNewName: "Enter new name...",
                confirm: "Confirm",
                switch: "Switch",
                todayProgress: "Today's Progress",
                addPlaceholder: "Add a new challenge...",
                aiButtonShow: "Get AI Suggestions",
                aiButtonHide: "Hide AI Suggestions",
                aiGoalPlaceholder: "e.g., I want to be active...",
                aiGenerate: "Generate",
                streak: "day streak",
                noHabits: "No habits yet, add one to start!",
                syncing: "Syncing data...",
                deleteConfirm: "Are you sure you want to delete?",
                aiSystemPrompt: "You are a behavioral psychologist. Based on the user's goal, suggest 3 micro-habits in English, including name (max 10 words) and reason (max 15 words). Format: JSON array.",
                months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                langLabel: "Language",
                dateLocale: "en-US",
                quotes: [
                    "Success is not final, failure is not fatal: it is the courage to continue that counts.",
                    "A journey of a thousand miles begins with a single step.",
                    "Luck is what happens when preparation meets opportunity.",
                    "First we form habits, then they form us.",
                    "The best time to plant a tree was 20 years ago. The second best time is now.",
                    "Excellence is not an act, but a habit.",
                    "If you get 1% better each day, you'll be 37 times better by the end of the year.",
                    "All greatness starts with a brave beginning.",
                    "You are the product of your habits, so choose them wisely."
                ]
            }
        };

        // --- 圖示 ---
        const Icon = ({ path, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        const Plus = (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />;
        const Trash2 = (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />;
        const Check = (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12"/>} />;
        const Flame = (props) => <Icon {...props} fill={props.fill || "none"} path={<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.09.88-2.15 1.7-2.9.3 2.1 1.3 3.7 1.3 5.7z"/>} />;
        const Trophy = (props) => <Icon {...props} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2h-4c0 1.25-.9 2.1-2 2.1s-2-.85-2-2.1H6c-2.3 0-4 1.7-4 4 0 4.1 3 7.3 7 7.9V14c0 1.5 1 2.5 3 2.5s3-1 3-2.5v-.1c4-.6 7-3.8 7-7.9 0-2.3-1.7-4-4-4z"/></>} />;
        const CalendarIcon = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const ChevronLeft = (props) => <Icon {...props} path={<path d="m15 18-6-6 6-6"/>} />;
        const ChevronRight = (props) => <Icon {...props} path={<path d="m9 18 6-6-6-6"/>} />;
        const ChevronDown = (props) => <Icon {...props} path={<path d="m6 9 6 6 6-6"/>} />;
        const Sparkles = (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></>} />;
        const UserCircle = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const Loader2 = (props) => <Icon {...props} className={`${props.className} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />;
        const CalendarDays = (props) => <Icon {...props} path={<><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></>} />;
        const QuoteIcon = (props) => <Icon {...props} path={<path d="M3 21c3 0 7-1 7-8V5c0-1.25-.75-2-2-2H4c-1.25 0-2 .75-2 2v7c0 1.25.75 2 2 2h4c0 2.5-1 4.5-4 5.5l1 1.5ZM13 21c3 0 7-1 7-8V5c0-1.25-.75-2-2-2h-4c-1.25 0-2 .75-2 2v7c0 1.25.75 2 2 2h4c0 2.5-1 4.5-4 5.5l1 1.5Z"/>} />;

        // --- 子組件：日曆 ---
        const MiniCalendar = ({ completedDates, colorClass, lang }) => {
            const t = translations[lang];
            const [currentDate, setCurrentDate] = useState(new Date());
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();

            const renderDays = () => {
                const days = [];
                for (let i = 0; i < firstDayOfMonth; i++) days.push(<div key={`e-${i}`} className="h-8 w-8"></div>);
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isCompleted = completedDates?.includes(dateStr);
                    const isToday = dateStr === new Date().toISOString().split('T')[0];
                    days.push(
                        <div key={day} className="flex items-center justify-center h-8 w-8 relative text-[10px]">
                            <span className={`z-10 ${isCompleted ? 'text-white font-bold' : isToday ? 'text-indigo-600 font-bold' : 'text-slate-600'}`}>{day}</span>
                            {isCompleted && <div className={`absolute inset-0 m-1 rounded-full ${colorClass}`}></div>}
                            {!isCompleted && isToday && <div className="absolute inset-0 m-1 rounded-full border-2 border-indigo-200"></div>}
                        </div>
                    );
                }
                return days;
            };

            return (
                <div className="bg-slate-50 rounded-xl p-3 mt-4 border border-slate-100">
                    <div className="flex justify-between items-center mb-3 text-sm font-bold text-slate-700">
                        <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))}><ChevronLeft className="w-4 h-4" /></button>
                        <span>{t.months[month]}</span>
                        <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))}><ChevronRight className="w-4 h-4" /></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center">
                        {t.days.map(d => <div key={d} className="text-[10px] text-slate-400 h-5 font-bold">{d}</div>)}
                        {renderDays()}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [lang, setLang] = useState(localStorage.getItem('habit-lang') || 'zh');
            const t = translations[lang];
            const [activeName, setActiveName] = useState(localStorage.getItem('habit-user-name') || 'Guest');
            const [userList, setUserList] = useState(() => {
                const saved = localStorage.getItem('habit-user-list');
                return saved ? JSON.parse(saved) : ['Guest'];
            });
            const [habits, setHabits] = useState([]);
            const [newHabitName, setNewHabitName] = useState('');
            const [expandedHabitId, setExpandedHabitId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showUserPanel, setShowUserPanel] = useState(false);
            const [tempName, setTempName] = useState('');
            const [authenticated, setAuthenticated] = useState(false);
            const [showAI, setShowAI] = useState(false);
            const [aiGoal, setAiGoal] = useState('');
            const [aiSuggestions, setAiSuggestions] = useState([]);
            const [loadingAI, setLoadingAI] = useState(false);

            const dbRef = useRef(null);
            const today = new Date().toISOString().split('T')[0];

            // 1. 初始化與身份驗證
            useEffect(() => {
                const setupFirebase = async () => {
                    if (!firebaseConfig || !window.FirebaseSDK) {
                        // 本地模式：直接讀取 LocalStorage
                        const saved = localStorage.getItem(`local-habits-${activeName}`);
                        if (saved) setHabits(JSON.parse(saved));
                        setLoading(false);
                        return;
                    }

                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FirebaseSDK;
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    dbRef.current = getFirestore(app);

                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(e) { console.error("Firebase Auth Error:", e); }

                    const unsubscribe = onAuthStateChanged(auth, (user) => { if (user) setAuthenticated(true); });
                    return unsubscribe;
                };

                // 等待模組加載完成
                if (window.FirebaseSDK) {
                    setupFirebase();
                } else {
                    window.addEventListener('firebase-ready', setupFirebase);
                }
            }, [activeName]);

            // 2. 數據監聽與同步
            useEffect(() => {
                if (!firebaseConfig) return; // 本地模式由下方 useEffect 處理
                if (!authenticated || !activeName || !dbRef.current) return;
                
                setLoading(true);
                const { collection, onSnapshot } = window.FirebaseSDK;
                const habitsCol = collection(dbRef.current, 'artifacts', appId, 'public', 'data', activeName);
                const unsubscribe = onSnapshot(habitsCol, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setHabits(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore Listen Error:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [authenticated, activeName]);

            // 3. 本地儲存同步 (GitHub Pages 備援)
            useEffect(() => {
                if (!firebaseConfig) {
                    localStorage.setItem(`local-habits-${activeName}`, JSON.stringify(habits));
                }
            }, [habits, activeName]);

            const selectLang = (nl) => { setLang(nl); localStorage.setItem('habit-lang', nl); };

            const addHabit = async (name) => {
                if (!name.trim()) return;
                if (firebaseConfig && authenticated) {
                    const { collection, addDoc } = window.FirebaseSDK;
                    await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', activeName), { name, completedDates: [], createdAt: Date.now() });
                } else {
                    const newH = { id: Date.now().toString(), name, completedDates: [], createdAt: Date.now() };
                    setHabits(prev => [...prev, newH]);
                }
            };

            const toggleHabit = async (habit) => {
                const isDone = habit.completedDates?.includes(today);
                const newDates = isDone ? habit.completedDates.filter(d => d !== today) : [...(habit.completedDates || []), today];
                
                if (firebaseConfig && authenticated) {
                    const { doc, updateDoc } = window.FirebaseSDK;
                    await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', activeName, habit.id), { completedDates: newDates });
                } else {
                    setHabits(prev => prev.map(h => h.id === habit.id ? { ...h, completedDates: newDates } : h));
                }
            };

            const deleteHabit = async (id) => {
                if (!window.confirm(t.deleteConfirm)) return;
                if (firebaseConfig && authenticated) {
                    const { doc, deleteDoc } = window.FirebaseSDK;
                    await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', activeName, id));
                } else {
                    setHabits(prev => prev.filter(h => h.id !== id));
                }
            };

            const updateActiveUser = (n) => {
                setActiveName(n);
                localStorage.setItem('habit-user-name', n);
                if (!userList.includes(n)) {
                    const newList = [...userList, n];
                    setUserList(newList);
                    localStorage.setItem('habit-user-list', JSON.stringify(newList));
                }
            };

            const calculateStreak = (dates) => {
                if (!dates || dates.length === 0) return 0;
                let streak = 0, check = new Date();
                if (!dates.includes(today)) check.setDate(check.getDate() - 1);
                while(dates.includes(check.toISOString().split('T')[0])) { streak++; check.setDate(check.getDate() - 1); }
                return streak;
            };

            const formattedDate = new Date().toLocaleDateString(t.dateLocale, { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            const quote = t.quotes[Math.floor((new Date().getDate() + new Date().getMonth() * 31) % t.quotes.length)];

            const completedToday = habits.filter(h => h.completedDates?.includes(today)).length;
            const progress = habits.length > 0 ? (completedToday / habits.length) * 100 : 0;

            return (
                <div className="min-h-screen bg-slate-50 py-8 px-4 flex flex-col items-center">
                    <div className="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 flex flex-col h-[90vh]">
                        <div className="bg-indigo-600 p-6 text-white relative shadow-inner">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold flex items-center gap-2 font-serif"><Trophy className="w-6 h-6 text-yellow-300" />{t.title}</h1>
                                    <p className="text-[11px] text-indigo-100 mt-1 flex items-center gap-1.5 opacity-90 font-medium"><CalendarDays className="w-3 h-3" />{formattedDate}</p>
                                    <button onClick={() => { setShowUserPanel(!showUserPanel); setTempName(''); }} className="mt-3 text-[10px] bg-white/10 px-3 py-1 rounded-full border border-white/10 hover:bg-white/20 transition-all">{t.switchUser}{activeName}</button>
                                </div>
                                <div className="flex flex-col items-end gap-3">
                                    <select value={lang} onChange={(e) => selectLang(e.target.value)} className="bg-white/10 text-white text-[10px] font-bold py-1.5 pl-2 pr-6 rounded-lg border border-white/20 appearance-none focus:outline-none cursor-pointer">
                                        <option value="zh" className="text-slate-800">繁體中文</option>
                                        <option value="vi" className="text-slate-800">Tiếng Việt</option>
                                        <option value="en" className="text-slate-800">English</option>
                                    </select>
                                    <div className="text-right"><span className="text-3xl font-bold">{completedToday}</span><span className="text-indigo-300 text-sm">/{habits.length}</span></div>
                                </div>
                            </div>
                            {showUserPanel && (
                                <div className="bg-indigo-800/95 rounded-2xl p-4 mb-4 border border-indigo-400/30 animate-in fade-in zoom-in duration-200">
                                    <div className="mb-4">
                                        <p className="text-[10px] font-bold text-indigo-300 mb-2 uppercase tracking-wider">{t.recentUsers}</p>
                                        <div className="flex flex-wrap gap-2 user-list-scroll pr-1">
                                            {userList.map(name => (
                                                <button key={name} onClick={() => { updateActiveUser(name); setShowUserPanel(false); }} className={`px-3 py-1.5 rounded-lg text-xs transition-all ${activeName === name ? 'bg-yellow-400 text-indigo-900 font-bold shadow-lg shadow-yellow-400/20' : 'bg-indigo-700/50 text-white hover:bg-indigo-600 border border-indigo-500/30'}`}>{name}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <form onSubmit={(e) => { e.preventDefault(); if(tempName.trim()) { updateActiveUser(tempName.trim()); setShowUserPanel(false); } }} className="pt-3 border-t border-indigo-500/30 flex gap-2">
                                        <input type="text" value={tempName} onChange={(e) => setTempName(e.target.value)} placeholder={t.inputNewName} className="flex-1 bg-indigo-900/40 border border-indigo-500/30 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-white transition-all" />
                                        <button type="submit" className="bg-white text-indigo-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-colors">{t.switch}</button>
                                    </form>
                                </div>
                            )}
                            <div className="w-full bg-indigo-900/30 rounded-full h-2 mt-2 overflow-hidden">
                                <div className="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all duration-700" style={{ width: `${progress}%` }}></div>
                            </div>
                            <div className="flex justify-between mt-1 text-[10px] text-indigo-200 uppercase tracking-tighter"><span>{t.todayProgress}</span><span>{Math.round(progress)}%</span></div>
                        </div>

                        <div className="p-6 flex-1 overflow-y-auto no-scrollbar">
                            <form onSubmit={(e) => { e.preventDefault(); addHabit(newHabitName); setNewHabitName(''); }} className="mb-6 relative">
                                <input type="text" value={newHabitName} onChange={(e) => setNewHabitName(e.target.value)} placeholder={t.addPlaceholder} className="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <button type="submit" className="absolute right-2 top-2 bottom-2 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition-colors"><Plus className="w-5 h-5" /></button>
                            </form>

                            <button onClick={() => setShowAI(!showAI)} className={`w-full py-2 px-4 rounded-xl flex items-center justify-center gap-2 text-sm font-medium mb-4 transition-all ${showAI ? 'bg-purple-100 text-purple-700 border border-purple-200 shadow-sm' : 'bg-white border border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                <Sparkles className="w-4 h-4" />{showAI ? t.aiButtonHide : t.aiButtonShow}
                            </button>

                            {showAI && (
                                <div className="bg-purple-50 rounded-xl p-4 border border-purple-100 mb-6 animate-in slide-in-from-top-2">
                                    <form onSubmit={async (e) => {
                                        e.preventDefault();
                                        if (!aiGoal.trim()) return;
                                        setLoadingAI(true);
                                        try {
                                            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                                                method: "POST", headers: { "Content-Type": "application/json" },
                                                body: JSON.stringify({ contents: [{ parts: [{ text: `Goal/目標：${aiGoal}。${t.aiSystemPrompt}` }] }], generationConfig: { responseMimeType: "application/json" } }),
                                            });
                                            const data = await res.json();
                                            setAiSuggestions(JSON.parse(data.candidates[0].content.parts[0].text));
                                        } catch (e) { alert("AI Service Error"); }
                                        setLoadingAI(false);
                                    }} className="flex gap-2 mb-2">
                                        <input type="text" value={aiGoal} onChange={(e) => setAiGoal(e.target.value)} placeholder={t.aiGoalPlaceholder} className="flex-1 px-3 py-2 text-sm rounded-lg border border-purple-200 outline-none" />
                                        <button type="submit" className="bg-purple-600 text-white px-4 py-2 rounded-lg text-xs font-bold disabled:opacity-50" disabled={loadingAI}>{loadingAI ? <Loader2 className="w-4 h-4" /> : t.aiGenerate}</button>
                                    </form>
                                    <div className="space-y-2">
                                        {aiSuggestions.map((s, i) => (
                                            <div key={i} className="bg-white p-3 rounded-lg border border-purple-100 shadow-sm flex items-center justify-between transition-all hover:border-purple-300">
                                                <div className="flex-1 min-w-0 mr-2"><h4 className="font-bold text-sm text-slate-700">{s.name}</h4><p className="text-[10px] text-slate-500 truncate">{s.reason}</p></div>
                                                <button onClick={() => { addHabit(s.name); setAiSuggestions(prev => prev.filter(x => x.name !== s.name)); }} className="bg-purple-100 text-purple-700 p-1.5 rounded hover:bg-purple-200 transition-colors"><Plus className="w-4 h-4" /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {loading ? <div className="text-center py-10 text-slate-300 text-sm animate-pulse italic">{t.syncing}</div> : (
                                <div className="space-y-3 no-scrollbar pb-4">
                                    {habits.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)).map(habit => {
                                        const isDone = habit.completedDates?.includes(today);
                                        const streak = calculateStreak(habit.completedDates);
                                        return (
                                            <div key={habit.id} className={`p-4 rounded-2xl border transition-all duration-300 ${isDone ? 'bg-green-50 border-green-200 shadow-sm' : 'bg-white border-slate-100 shadow-sm hover:border-indigo-100'}`}>
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-4 flex-1 cursor-pointer" onClick={() => toggleHabit(habit)}>
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${isDone ? 'bg-green-500 text-white scale-110' : 'bg-slate-50 text-slate-300'}`}><Check className="w-5 h-5" strokeWidth={3} /></div>
                                                        <div><h3 className={`font-semibold text-sm transition-all ${isDone ? 'text-slate-400 line-through' : 'text-slate-700'}`}>{habit.name}</h3><span className="text-[10px] text-orange-500 font-bold flex items-center gap-0.5"><Flame className="w-3 h-3" fill="currentColor"/> {streak} {t.streak}</span></div>
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <button onClick={() => setExpandedHabitId(expandedHabitId === habit.id ? null : habit.id)} className={`p-2 rounded-lg transition-colors ${expandedHabitId === habit.id ? 'bg-indigo-100 text-indigo-600' : 'text-slate-200 hover:text-indigo-400'}`}><CalendarIcon className="w-4 h-4" /></button>
                                                        <button onClick={() => deleteHabit(habit.id)} className="text-slate-100 hover:text-red-400 transition-colors p-2"><Trash2 className="w-4 h-4" /></button>
                                                    </div>
                                                </div>
                                                {expandedHabitId === habit.id && <MiniCalendar completedDates={habit.completedDates} colorClass={isDone ? 'bg-green-500' : 'bg-indigo-500'} lang={lang} />}
                                            </div>
                                        );
                                    })}
                                    {habits.length === 0 && <div className="text-center py-10 text-slate-300 text-sm italic">{t.noHabits}</div>}
                                </div>
                            )}
                        </div>

                        <div className="p-5 bg-slate-50 border-t border-slate-100 flex flex-col items-center gap-2 w-full">
                            <QuoteIcon className="w-4 h-4 text-indigo-200 opacity-50 flex-shrink-0" />
                            <p className="text-xs text-slate-500 italic font-medium text-center leading-relaxed px-4">"{quote}"</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
